# Docker Compose å¼€å‘ç¯å¢ƒé…ç½®
# æä¾›å®Œæ•´çš„ Tauri + React å¼€å‘ç¯å¢ƒ

version: '3.8'

services:
  tauri-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: tauri-react-dev
    volumes:
      # æŒ‚è½½é¡¹ç›®ç›®å½•
      - .:/workspace
      # æŒ‚è½½ Cargo ç¼“å­˜
      - cargo-cache:/root/.cargo
      # æŒ‚è½½ Node.js ç¼“å­˜
      - node-cache:/workspace/node_modules
      # æŒ‚è½½ Android SDK (å¯é€‰ï¼Œç”¨äºæŒä¹…åŒ–)
      - android-sdk:/opt/android-sdk
    ports:
      # Vite å¼€å‘æœåŠ¡å™¨
      - '1420:1420'
      # å¤‡ç”¨ç«¯å£
      - '3000:3000'
      - '8080:8080'
      # Android ADB ç«¯å£
      - '5037:5037'
    environment:
      # å¼€å‘ç¯å¢ƒå˜é‡
      - NODE_ENV=development
      - RUST_LOG=debug
      - TAURI_DEBUG=true
      # Android ç¯å¢ƒ
      - ANDROID_HOME=/opt/android-sdk
      - ANDROID_SDK_ROOT=/opt/android-sdk
      - ANDROID_NDK_HOME=/opt/android-sdk/ndk/25.2.9519653
      # æ˜¾ç¤ºç›¸å…³ (ç”¨äº GUI åº”ç”¨)
      - DISPLAY=${DISPLAY:-:0}
    devices:
      # GPU è®¿é—® (ç”¨äºç¡¬ä»¶åŠ é€Ÿ)
      - /dev/dri:/dev/dri
    privileged: true
    stdin_open: true
    tty: true
    working_dir: /workspace
    command: >
      bash -c "
        echo 'ğŸš€ Tauri + React å¼€å‘ç¯å¢ƒå·²å¯åŠ¨'
        echo 'ğŸ“ é¡¹ç›®ç›®å½•: /workspace'
        echo 'ğŸ”§ å¯ç”¨å‘½ä»¤:'
        echo '  - npm run dev          # æ¡Œé¢å¼€å‘'
        echo '  - npm run dev:android  # Android å¼€å‘'
        echo '  - npm run check:env    # ç¯å¢ƒæ£€æŸ¥'
        echo '  - npm run emulator:start # å¯åŠ¨æ¨¡æ‹Ÿå™¨'
        echo ''
        echo 'ğŸ’¡ æç¤º: ä½¿ç”¨ docker-compose exec tauri-dev bash è¿›å…¥å®¹å™¨'
        echo ''
        exec bash
      "

  # å¯é€‰ï¼šç‹¬ç«‹çš„ Android æ¨¡æ‹Ÿå™¨æœåŠ¡
  android-emulator:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: android-emulator
    volumes:
      - android-sdk:/opt/android-sdk
    ports:
      - '5554:5554' # æ¨¡æ‹Ÿå™¨ç«¯å£
      - '5555:5555' # æ¨¡æ‹Ÿå™¨æ§åˆ¶å°ç«¯å£
    environment:
      - ANDROID_HOME=/opt/android-sdk
      - ANDROID_SDK_ROOT=/opt/android-sdk
      - DISPLAY=${DISPLAY:-:0}
    devices:
      - /dev/kvm:/dev/kvm # KVM ç¡¬ä»¶åŠ é€Ÿ (Linux)
      - /dev/dri:/dev/dri # GPU è®¿é—®
    privileged: true
    command: >
      bash -c "
        echo 'ğŸ¤– å¯åŠ¨ Android æ¨¡æ‹Ÿå™¨...'
        emulator -avd tauri_dev -no-window -no-audio -gpu auto &
        echo 'âœ… Android æ¨¡æ‹Ÿå™¨å·²åœ¨åå°å¯åŠ¨'
        tail -f /dev/null
      "
    profiles:
      - emulator

volumes:
  # æŒä¹…åŒ–ç¼“å­˜å·
  cargo-cache:
    driver: local
  node-cache:
    driver: local
  android-sdk:
    driver: local

networks:
  default:
    name: tauri-dev-network
