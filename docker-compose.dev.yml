# Docker Compose 开发环境配置
# 提供完整的 Tauri + React 开发环境

version: '3.8'

services:
  tauri-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: tauri-react-dev
    volumes:
      # 挂载项目目录
      - .:/workspace
      # 挂载 Cargo 缓存
      - cargo-cache:/root/.cargo
      # 挂载 Node.js 缓存
      - node-cache:/workspace/node_modules
      # 挂载 Android SDK (可选，用于持久化)
      - android-sdk:/opt/android-sdk
    ports:
      # Vite 开发服务器
      - '1420:1420'
      # 备用端口
      - '3000:3000'
      - '8080:8080'
      # Android ADB 端口
      - '5037:5037'
    environment:
      # 开发环境变量
      - NODE_ENV=development
      - RUST_LOG=debug
      - TAURI_DEBUG=true
      # Android 环境
      - ANDROID_HOME=/opt/android-sdk
      - ANDROID_SDK_ROOT=/opt/android-sdk
      - ANDROID_NDK_HOME=/opt/android-sdk/ndk/25.2.9519653
      # 显示相关 (用于 GUI 应用)
      - DISPLAY=${DISPLAY:-:0}
    devices:
      # GPU 访问 (用于硬件加速)
      - /dev/dri:/dev/dri
    privileged: true
    stdin_open: true
    tty: true
    working_dir: /workspace
    command: >
      bash -c "
        echo '🚀 Tauri + React 开发环境已启动'
        echo '📁 项目目录: /workspace'
        echo '🔧 可用命令:'
        echo '  - npm run dev          # 桌面开发'
        echo '  - npm run dev:android  # Android 开发'
        echo '  - npm run check:env    # 环境检查'
        echo '  - npm run emulator:start # 启动模拟器'
        echo ''
        echo '💡 提示: 使用 docker-compose exec tauri-dev bash 进入容器'
        echo ''
        exec bash
      "

  # 可选：独立的 Android 模拟器服务
  android-emulator:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: android-emulator
    volumes:
      - android-sdk:/opt/android-sdk
    ports:
      - '5554:5554' # 模拟器端口
      - '5555:5555' # 模拟器控制台端口
    environment:
      - ANDROID_HOME=/opt/android-sdk
      - ANDROID_SDK_ROOT=/opt/android-sdk
      - DISPLAY=${DISPLAY:-:0}
    devices:
      - /dev/kvm:/dev/kvm # KVM 硬件加速 (Linux)
      - /dev/dri:/dev/dri # GPU 访问
    privileged: true
    command: >
      bash -c "
        echo '🤖 启动 Android 模拟器...'
        emulator -avd tauri_dev -no-window -no-audio -gpu auto &
        echo '✅ Android 模拟器已在后台启动'
        tail -f /dev/null
      "
    profiles:
      - emulator

volumes:
  # 持久化缓存卷
  cargo-cache:
    driver: local
  node-cache:
    driver: local
  android-sdk:
    driver: local

networks:
  default:
    name: tauri-dev-network
