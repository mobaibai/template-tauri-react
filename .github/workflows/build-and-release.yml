name: Build and Release

# æ·»åŠ æƒé™é…ç½®ä»¥è§£å†³ Create Release æƒé™é”™è¯¯
permissions:
  contents: write
  packages: write
  actions: read
  security-events: write

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'draft'
        type: choice
        options:
          - draft
          - prerelease
          - release

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # å‰ç«¯æ„å»ºå’Œæµ‹è¯•
  frontend-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 'latest'
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript check
        run: pnpm run type-check

      - name: Run ESLint
        run: pnpm run lint

      - name: Check code formatting
        run: pnpm run format:check

      - name: Build frontend
        run: pnpm run build

      - name: Upload frontend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/
          retention-days: 1

  # macOS æ„å»º
  build-macos:
    needs: frontend-test
    runs-on: macos-latest
    strategy:
      matrix:
        target: [x86_64-apple-darwin, aarch64-apple-darwin]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 'latest'
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust toolchain
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-rust-toolchain-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-toolchain-
        timeout-minutes: 10
        continue-on-error: true

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          key: ${{ matrix.target }}
          cache-targets: true
          cache-on-failure: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Build Tauri app
        run: |
          if [ "${{ matrix.target }}" = "x86_64-apple-darwin" ]; then
            pnpm run build:mac-x86
          else
            pnpm run build:mac-aarch
          fi

      - name: Create dist-builds directory if not exists
        run: |
          mkdir -p dist-builds
          ls -la dist-builds/

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.target }}
          path: dist-builds/
          retention-days: 3
        if: always()

  # Windows æ„å»º
  build-windows:
    needs: frontend-test
    runs-on: windows-latest
    strategy:
      matrix:
        # æ³¨é‡Šæ‰ aarch64-pc-windows-msvc: x86_64 ç‰ˆæœ¬åœ¨ ARM èŠ¯ç‰‡ä¸Šä¹Ÿèƒ½è¿è¡Œ
        target: [x86_64-pc-windows-msvc] # , aarch64-pc-windows-msvc
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 'latest'
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo-xwin
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-xwin
          key: ${{ runner.os }}-cargo-xwin-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-xwin-
        timeout-minutes: 5
        continue-on-error: true

      - name: Install cargo-xwin (Windows cross-compilation)
        shell: bash
        run: |
          if ! command -v cargo-xwin &> /dev/null; then
            cargo install cargo-xwin
          else
            echo "cargo-xwin already installed"
          fi

      - name: Cache Rust toolchain
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-rust-toolchain-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-toolchain-
        timeout-minutes: 10
        continue-on-error: true

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          key: ${{ matrix.target }}
          cache-targets: true
          cache-on-failure: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Build Tauri app
        run: |
          if ("${{ matrix.target }}" -eq "x86_64-pc-windows-msvc") {
            pnpm run build:win-x86
          } else {
            pnpm run build:win-aarch
          }

      - name: Create dist-builds directory if not exists
        run: |
          if (-not (Test-Path "dist-builds")) {
            New-Item -ItemType Directory -Path "dist-builds" -Force
          }
          Get-ChildItem -Path "dist-builds" -Recurse

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.target }}
          path: dist-builds/
          retention-days: 3
        if: always()

  # Linux æ„å»º
  build-linux:
    needs: frontend-test
    runs-on: ubuntu-latest
    timeout-minutes: 90
    strategy:
      matrix:
        # æ³¨é‡Šæ‰ aarch64-unknown-linux-gnu: x86_64 ç‰ˆæœ¬åœ¨ ARM èŠ¯ç‰‡ä¸Šä¹Ÿèƒ½è¿è¡Œ
        target: [x86_64-unknown-linux-gnu] # , aarch64-unknown-linux-gnu
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 'latest'
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache system dependencies
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt
            /var/lib/apt
          key: ${{ runner.os }}-apt-${{ hashFiles('**/.github/workflows/build-and-release.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-
        timeout-minutes: 5
        continue-on-error: true

      - name: Cache Rust toolchain
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-rust-toolchain-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-toolchain-
        timeout-minutes: 10
        continue-on-error: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf pkg-config libssl-dev

          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            echo "=== å®‰è£… aarch64 äº¤å‰ç¼–è¯‘å·¥å…·é“¾ ==="
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu libc6-dev-arm64-cross
            
            # å®‰è£… aarch64 ç³»ç»Ÿåº“ä¾èµ–
            sudo apt-get install -y libwebkit2gtk-4.1-dev:arm64 libappindicator3-dev:arm64 librsvg2-dev:arm64 libssl-dev:arm64 || true
            sudo apt-get install -y libdbus-1-dev:arm64 libglib2.0-dev:arm64 libgtk-3-dev:arm64 || true
            
            # éªŒè¯å·¥å…·é“¾å®‰è£…
            echo "=== éªŒè¯äº¤å‰ç¼–è¯‘å·¥å…·é“¾ ==="
            which aarch64-linux-gnu-gcc
            aarch64-linux-gnu-gcc --version
            which aarch64-linux-gnu-g++
            aarch64-linux-gnu-g++ --version
            
            # æ£€æŸ¥ pkg-config è·¯å¾„
            ls -la /usr/lib/aarch64-linux-gnu/pkgconfig/ || echo "aarch64 pkgconfig directory not found"
            
            # è®¾ç½® pkg-config æœç´¢è·¯å¾„
            export PKG_CONFIG_PATH="/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig"
            echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
          fi

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          key: ${{ matrix.target }}
          cache-targets: true
          cache-on-failure: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Build Tauri app
        run: |
          if [ "${{ matrix.target }}" = "x86_64-unknown-linux-gnu" ]; then
            pnpm run build:linux-x86
          else
            # ä¸º aarch64 äº¤å‰ç¼–è¯‘è®¾ç½®è¯¦ç»†çš„ç¯å¢ƒå˜é‡
            export CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
            export CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++
            export AR_aarch64_unknown_linux_gnu=aarch64-linux-gnu-ar
            export STRIP_aarch64_unknown_linux_gnu=aarch64-linux-gnu-strip
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
            export PKG_CONFIG_ALLOW_CROSS=1
            export PKG_CONFIG_PATH_aarch64_unknown_linux_gnu=/usr/lib/aarch64-linux-gnu/pkgconfig
            
            # è°ƒè¯•ä¿¡æ¯
            echo "=== äº¤å‰ç¼–è¯‘ç¯å¢ƒæ£€æŸ¥ ==="
            which aarch64-linux-gnu-gcc || echo "aarch64-linux-gnu-gcc not found"
            aarch64-linux-gnu-gcc --version || echo "aarch64-linux-gnu-gcc version check failed"
            echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=$CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER"
            echo "=== å¼€å§‹æ„å»º ==="
            
            pnpm run build:linux-aarch
          fi
        env:
          PKG_CONFIG_ALLOW_CROSS: 1
          # ä½¿ç”¨vendored OpenSSLé¿å…äº¤å‰ç¼–è¯‘ä¾èµ–é—®é¢˜
          OPENSSL_STATIC: 1
          OPENSSL_VENDORED: 1

      - name: Create dist-builds directory if not exists
        run: |
          mkdir -p dist-builds
          ls -la dist-builds/

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.target }}
          path: dist-builds/
          retention-days: 3
        if: always()

  # åˆ›å»º Release
  create-release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(date +%Y%m%d-%H%M%S)
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name || format('v{0}', steps.get_version.outputs.VERSION) }}
          release_name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ğŸš€ Release ${{ steps.get_version.outputs.VERSION }}

            ### ğŸ“¦ ä¸‹è½½é“¾æ¥

            #### æ¡Œé¢ç‰ˆæœ¬
            - **macOS**: æ”¯æŒ Intel (x86_64) å’Œ Apple Silicon (ARM64)
            - **Windows**: æ”¯æŒ x86_64 (å…¼å®¹ ARM64 èŠ¯ç‰‡)
            - **Linux**: æ”¯æŒ x86_64 (å…¼å®¹ ARM64 èŠ¯ç‰‡) (AppImage, DEB, RPM)

            > **æ³¨æ„**: Windows å’Œ Linux çš„ x86_64 ç‰ˆæœ¬å¯ä»¥åœ¨ ARM64 èŠ¯ç‰‡ä¸Šè¿è¡Œï¼Œå› æ­¤ä¸å†å•ç‹¬æä¾› ARM64 åŸç”Ÿç‰ˆæœ¬ã€‚



            ### ğŸ”§ å®‰è£…è¯´æ˜

            #### macOS
            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ `.dmg` æ–‡ä»¶
            2. åŒå‡»æ‰“å¼€å¹¶æ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
            3. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸

            #### Windows
            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ `.exe` å®‰è£…ç¨‹åº
            2. è¿è¡Œå®‰è£…ç¨‹åºå¹¶æŒ‰æç¤ºæ“ä½œ
            3. Windows Defender å¯èƒ½ä¼šæ˜¾ç¤ºè­¦å‘Šï¼Œé€‰æ‹©"ä»è¦è¿è¡Œ"

            #### Linux
            - **AppImage**: ä¸‹è½½åæ·»åŠ æ‰§è¡Œæƒé™ `chmod +x *.AppImage`
            - **DEB**: ä½¿ç”¨ `sudo dpkg -i *.deb` å®‰è£…
            - **RPM**: ä½¿ç”¨ `sudo rpm -i *.rpm` å®‰è£…



            ---

            **å®Œæ•´æ›´æ–°æ—¥å¿—**: [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          draft: ${{ github.event.inputs.release_type == 'draft' || github.event_name != 'workflow_dispatch' }}
          prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}

  # ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Release
  upload-release-assets:
    needs: [create-release, build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - artifact: macos-x86_64-apple-darwin
            pattern: '*.dmg'
            name: 'macOS-Intel'
            build_job: 'build-macos'
          - artifact: macos-aarch64-apple-darwin
            pattern: '*.dmg'
            name: 'macOS-AppleSilicon'
            build_job: 'build-macos'
          - artifact: windows-x86_64-pc-windows-msvc
            pattern: '*.exe'
            name: 'Windows-x64'
            build_job: 'build-windows'
          # æ³¨é‡Šæ‰ ARM æ¶æ„ç‰ˆæœ¬: x86_64 ç‰ˆæœ¬åœ¨ ARM èŠ¯ç‰‡ä¸Šä¹Ÿèƒ½è¿è¡Œ
          # - artifact: windows-aarch64-pc-windows-msvc
          #   pattern: '*.exe'
          #   name: 'Windows-ARM64'
          #   build_job: 'build-windows'
          - artifact: linux-x86_64-unknown-linux-gnu
            pattern: '*.{AppImage,deb,rpm}'
            name: 'Linux-x64'
            build_job: 'build-linux'
          # - artifact: linux-aarch64-unknown-linux-gnu
          #   pattern: '*.{AppImage,deb,rpm}'
          #   name: 'Linux-ARM64'
          #   build_job: 'build-linux'
    steps:
      - name: Check if build succeeded
        id: check_build
        run: |
          if [ "${{ needs[matrix.build_job].result }}" = "success" ]; then
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
            echo "Build job ${{ matrix.build_job }} did not succeed, skipping artifact upload for ${{ matrix.artifact }}"
          fi

      - name: Download artifacts
        if: steps.check_build.outputs.build_success == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ./release-assets/
        continue-on-error: true

      - name: Upload Release Assets
        if: steps.check_build.outputs.build_success == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const { glob } = require('glob');

            const releaseId = '${{ needs.create-release.outputs.release_id }}';
            const artifactPath = './release-assets/';

            // æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
            if (!fs.existsSync(artifactPath)) {
              console.log(`Artifact path ${artifactPath} does not exist, skipping upload`);
              return;
            }

            // æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„æ–‡ä»¶
            const files = await glob('${{ matrix.pattern }}', { cwd: artifactPath });

            if (files.length === 0) {
              console.log(`No files found matching pattern '${{ matrix.pattern }}' in ${artifactPath}`);
              return;
            }

            for (const file of files) {
              const filePath = path.join(artifactPath, file);
              const fileName = path.basename(file);
              const fileData = fs.readFileSync(filePath);

              // ç”Ÿæˆå¸¦å¹³å°æ ‡è¯†çš„æ–‡ä»¶å
              const ext = path.extname(fileName);
              const baseName = path.basename(fileName, ext);
              const newFileName = `${baseName}-${{ matrix.name }}${ext}`;

              console.log(`Uploading ${newFileName}...`);

              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: releaseId,
                name: newFileName,
                data: fileData,
              });
            }

  # æ¸…ç†å·¥ä½œæµäº§ç‰©
  cleanup:
    needs: [upload-release-assets]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Delete workflow artifacts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            for (const artifact of artifacts.data.artifacts) {
              console.log(`Deleting artifact: ${artifact.name}`);
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
              });
            }
