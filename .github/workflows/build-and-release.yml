name: Build and Release

# Ê∑ªÂä†ÊùÉÈôêÈÖçÁΩÆ‰ª•Ëß£ÂÜ≥ Create Release ÊùÉÈôêÈîôËØØ
permissions:
  contents: write
  packages: write
  actions: read
  security-events: write

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'draft'
        type: choice
        options:
          - draft
          - prerelease
          - release
      include_mobile:
        description: 'Include mobile builds (iOS/Android)'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ÂâçÁ´ØÊûÑÂª∫ÂíåÊµãËØï
  frontend-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 'latest'
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript check
        run: pnpm run type-check

      - name: Run ESLint
        run: pnpm run lint

      - name: Check code formatting
        run: pnpm run format:check

      - name: Build frontend
        run: pnpm run build

      - name: Upload frontend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/
          retention-days: 1

  # macOS ÊûÑÂª∫
  build-macos:
    needs: frontend-test
    runs-on: macos-latest
    strategy:
      matrix:
        target: [x86_64-apple-darwin, aarch64-apple-darwin]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 'latest'
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust toolchain
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-rust-toolchain-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-toolchain-
        timeout-minutes: 10
        continue-on-error: true

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          key: ${{ matrix.target }}
          cache-targets: true
          cache-on-failure: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Build Tauri app
        run: |
          if [ "${{ matrix.target }}" = "x86_64-apple-darwin" ]; then
            pnpm run build:mac-x86
          else
            pnpm run build:mac-aarch
          fi

      - name: Create dist-builds directory if not exists
        run: |
          mkdir -p dist-builds
          ls -la dist-builds/

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.target }}
          path: dist-builds/
          retention-days: 3
        if: always()

  # Windows ÊûÑÂª∫
  build-windows:
    needs: frontend-test
    runs-on: windows-latest
    strategy:
      matrix:
        # Ê≥®ÈáäÊéâ aarch64-pc-windows-msvc: x86_64 ÁâàÊú¨Âú® ARM ËäØÁâá‰∏ä‰πüËÉΩËøêË°å
        target: [x86_64-pc-windows-msvc] # , aarch64-pc-windows-msvc
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 'latest'
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo-xwin
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-xwin
          key: ${{ runner.os }}-cargo-xwin-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-xwin-
        timeout-minutes: 5
        continue-on-error: true

      - name: Install cargo-xwin (Windows cross-compilation)
        shell: bash
        run: |
          if ! command -v cargo-xwin &> /dev/null; then
            cargo install cargo-xwin
          else
            echo "cargo-xwin already installed"
          fi

      - name: Cache Rust toolchain
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-rust-toolchain-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-toolchain-
        timeout-minutes: 10
        continue-on-error: true

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          key: ${{ matrix.target }}
          cache-targets: true
          cache-on-failure: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Build Tauri app
        run: |
          if ("${{ matrix.target }}" -eq "x86_64-pc-windows-msvc") {
            pnpm run build:win-x86
          } else {
            pnpm run build:win-aarch
          }

      - name: Create dist-builds directory if not exists
        run: |
          if (-not (Test-Path "dist-builds")) {
            New-Item -ItemType Directory -Path "dist-builds" -Force
          }
          Get-ChildItem -Path "dist-builds" -Recurse

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.target }}
          path: dist-builds/
          retention-days: 3
        if: always()

  # Linux ÊûÑÂª∫
  build-linux:
    needs: frontend-test
    runs-on: ubuntu-latest
    timeout-minutes: 90
    strategy:
      matrix:
        # Ê≥®ÈáäÊéâ aarch64-unknown-linux-gnu: x86_64 ÁâàÊú¨Âú® ARM ËäØÁâá‰∏ä‰πüËÉΩËøêË°å
        target: [x86_64-unknown-linux-gnu] # , aarch64-unknown-linux-gnu
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 'latest'
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache system dependencies
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt
            /var/lib/apt
          key: ${{ runner.os }}-apt-${{ hashFiles('**/.github/workflows/build-and-release.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-
        timeout-minutes: 5
        continue-on-error: true

      - name: Cache Rust toolchain
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-rust-toolchain-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-toolchain-
        timeout-minutes: 10
        continue-on-error: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf pkg-config libssl-dev

          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            echo "=== ÂÆâË£Ö aarch64 ‰∫§ÂèâÁºñËØëÂ∑•ÂÖ∑Èìæ ==="
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu libc6-dev-arm64-cross
            
            # ÂÆâË£Ö aarch64 Á≥ªÁªüÂ∫ì‰æùËµñ
            sudo apt-get install -y libwebkit2gtk-4.1-dev:arm64 libappindicator3-dev:arm64 librsvg2-dev:arm64 libssl-dev:arm64 || true
            sudo apt-get install -y libdbus-1-dev:arm64 libglib2.0-dev:arm64 libgtk-3-dev:arm64 || true
            
            # È™åËØÅÂ∑•ÂÖ∑ÈìæÂÆâË£Ö
            echo "=== È™åËØÅ‰∫§ÂèâÁºñËØëÂ∑•ÂÖ∑Èìæ ==="
            which aarch64-linux-gnu-gcc
            aarch64-linux-gnu-gcc --version
            which aarch64-linux-gnu-g++
            aarch64-linux-gnu-g++ --version
            
            # Ê£ÄÊü• pkg-config Ë∑ØÂæÑ
            ls -la /usr/lib/aarch64-linux-gnu/pkgconfig/ || echo "aarch64 pkgconfig directory not found"
            
            # ËÆæÁΩÆ pkg-config ÊêúÁ¥¢Ë∑ØÂæÑ
            export PKG_CONFIG_PATH="/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig"
            echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
          fi

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          key: ${{ matrix.target }}
          cache-targets: true
          cache-on-failure: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Build Tauri app
        run: |
          if [ "${{ matrix.target }}" = "x86_64-unknown-linux-gnu" ]; then
            pnpm run build:linux-x86
          else
            # ‰∏∫ aarch64 ‰∫§ÂèâÁºñËØëËÆæÁΩÆËØ¶ÁªÜÁöÑÁéØÂ¢ÉÂèòÈáè
            export CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
            export CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++
            export AR_aarch64_unknown_linux_gnu=aarch64-linux-gnu-ar
            export STRIP_aarch64_unknown_linux_gnu=aarch64-linux-gnu-strip
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
            export PKG_CONFIG_ALLOW_CROSS=1
            export PKG_CONFIG_PATH_aarch64_unknown_linux_gnu=/usr/lib/aarch64-linux-gnu/pkgconfig
            
            # Ë∞ÉËØï‰ø°ÊÅØ
            echo "=== ‰∫§ÂèâÁºñËØëÁéØÂ¢ÉÊ£ÄÊü• ==="
            which aarch64-linux-gnu-gcc || echo "aarch64-linux-gnu-gcc not found"
            aarch64-linux-gnu-gcc --version || echo "aarch64-linux-gnu-gcc version check failed"
            echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=$CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER"
            echo "=== ÂºÄÂßãÊûÑÂª∫ ==="
            
            pnpm run build:linux-aarch
          fi
        env:
          PKG_CONFIG_ALLOW_CROSS: 1
          # ‰ΩøÁî®vendored OpenSSLÈÅøÂÖç‰∫§ÂèâÁºñËØë‰æùËµñÈóÆÈ¢ò
          OPENSSL_STATIC: 1
          OPENSSL_VENDORED: 1

      - name: Create dist-builds directory if not exists
        run: |
          mkdir -p dist-builds
          ls -la dist-builds/

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.target }}
          path: dist-builds/
          retention-days: 3
        if: always()

  # iOS ÊûÑÂª∫ (‰ªÖÂú® macOS ‰∏ä)
  build-ios:
    needs: frontend-test
    runs-on: macos-latest
    if: (github.event_name == 'workflow_dispatch' && github.event.inputs.include_mobile == 'true') || contains(github.ref, 'mobile')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 'latest'
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Cache Rust toolchain
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-rust-toolchain-ios-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-toolchain-ios-
        timeout-minutes: 10
        continue-on-error: true

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Initialize iOS project
        run: pnpm run init:ios

      - name: Build iOS app
        run: pnpm run build:ios

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: dist-builds/
          retention-days: 3

  # Android ÊûÑÂª∫
  build-android:
    needs: frontend-test
    runs-on: ubuntu-latest
    if: (github.event_name == 'workflow_dispatch' && github.event.inputs.include_mobile == 'true') || contains(github.ref, 'mobile')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 'latest'
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Cache Rust toolchain
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-rust-toolchain-android-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-toolchain-android-
        timeout-minutes: 10
        continue-on-error: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Android NDK
        uses: actions/cache@v4
        with:
          path: ${{ env.ANDROID_SDK_ROOT }}/ndk
          key: ${{ runner.os }}-android-ndk-25.1.8937393
          restore-keys: |
            ${{ runner.os }}-android-ndk-
        timeout-minutes: 10
        continue-on-error: true

      - name: Install Android NDK
        run: |
          if [ ! -d "$ANDROID_SDK_ROOT/ndk/25.1.8937393" ]; then
            sdkmanager "ndk;25.1.8937393"
          else
            echo "Android NDK already installed"
          fi
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/25.1.8937393" >> $GITHUB_ENV

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Initialize Android project
        run: pnpm run init:android

      - name: Build Android app
        run: pnpm run build:android

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: dist-builds/
          retention-days: 3

  # ÂàõÂª∫ Release
  create-release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(date +%Y%m%d-%H%M%S)
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name || format('v{0}', steps.get_version.outputs.VERSION) }}
          release_name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## üöÄ Release ${{ steps.get_version.outputs.VERSION }}

            ### üì¶ ‰∏ãËΩΩÈìæÊé•

            #### Ê°åÈù¢ÁâàÊú¨
            - **macOS**: ÊîØÊåÅ Intel (x86_64) Âíå Apple Silicon (ARM64)
            - **Windows**: ÊîØÊåÅ x86_64 (ÂÖºÂÆπ ARM64 ËäØÁâá)
            - **Linux**: ÊîØÊåÅ x86_64 (ÂÖºÂÆπ ARM64 ËäØÁâá) (AppImage, DEB, RPM)

            > **Ê≥®ÊÑè**: Windows Âíå Linux ÁöÑ x86_64 ÁâàÊú¨ÂèØ‰ª•Âú® ARM64 ËäØÁâá‰∏äËøêË°åÔºåÂõ†Ê≠§‰∏çÂÜçÂçïÁã¨Êèê‰æõ ARM64 ÂéüÁîüÁâàÊú¨„ÄÇ

            #### ÁßªÂä®ÁâàÊú¨ (Â¶ÇÊûúÂèØÁî®)
            - **iOS**: ÈúÄË¶Å iOS 13.0 ÊàñÊõ¥È´òÁâàÊú¨
            - **Android**: ÈúÄË¶Å Android 7.0 (API 24) ÊàñÊõ¥È´òÁâàÊú¨

            ### üîß ÂÆâË£ÖËØ¥Êòé

            #### macOS
            1. ‰∏ãËΩΩÂØπÂ∫îÊû∂ÊûÑÁöÑ `.dmg` Êñá‰ª∂
            2. ÂèåÂáªÊâìÂºÄÂπ∂ÊãñÊãΩÂà∞Â∫îÁî®Á®ãÂ∫èÊñá‰ª∂Â§π
            3. È¶ñÊ¨°ËøêË°åÂèØËÉΩÈúÄË¶ÅÂú®Á≥ªÁªüÂÅèÂ•ΩËÆæÁΩÆ‰∏≠ÂÖÅËÆ∏

            #### Windows
            1. ‰∏ãËΩΩÂØπÂ∫îÊû∂ÊûÑÁöÑ `.exe` ÂÆâË£ÖÁ®ãÂ∫è
            2. ËøêË°åÂÆâË£ÖÁ®ãÂ∫èÂπ∂ÊåâÊèêÁ§∫Êìç‰Ωú
            3. Windows Defender ÂèØËÉΩ‰ºöÊòæÁ§∫Ë≠¶ÂëäÔºåÈÄâÊã©"‰ªçË¶ÅËøêË°å"

            #### Linux
            - **AppImage**: ‰∏ãËΩΩÂêéÊ∑ªÂä†ÊâßË°åÊùÉÈôê `chmod +x *.AppImage`
            - **DEB**: ‰ΩøÁî® `sudo dpkg -i *.deb` ÂÆâË£Ö
            - **RPM**: ‰ΩøÁî® `sudo rpm -i *.rpm` ÂÆâË£Ö

            ### üì± ÁßªÂä®Á´Ø
            - **iOS**: ÈúÄË¶ÅÈÄöËøá TestFlight Êàñ‰ºÅ‰∏öÂàÜÂèëÂÆâË£Ö
            - **Android**: ‰∏ãËΩΩ APK Êñá‰ª∂Âπ∂ÂÖÅËÆ∏Êú™Áü•Êù•Ê∫êÂÆâË£Ö

            ---

            **ÂÆåÊï¥Êõ¥Êñ∞Êó•Âøó**: [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          draft: ${{ github.event.inputs.release_type == 'draft' || github.event_name != 'workflow_dispatch' }}
          prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}

  # ‰∏ä‰º†ÊûÑÂª∫‰∫ßÁâ©Âà∞ Release
  upload-release-assets:
    needs: [create-release, build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - artifact: macos-x86_64-apple-darwin
            pattern: '*.dmg'
            name: 'macOS-Intel'
            build_job: 'build-macos'
          - artifact: macos-aarch64-apple-darwin
            pattern: '*.dmg'
            name: 'macOS-AppleSilicon'
            build_job: 'build-macos'
          - artifact: windows-x86_64-pc-windows-msvc
            pattern: '*.exe'
            name: 'Windows-x64'
            build_job: 'build-windows'
          # Ê≥®ÈáäÊéâ ARM Êû∂ÊûÑÁâàÊú¨: x86_64 ÁâàÊú¨Âú® ARM ËäØÁâá‰∏ä‰πüËÉΩËøêË°å
          # - artifact: windows-aarch64-pc-windows-msvc
          #   pattern: '*.exe'
          #   name: 'Windows-ARM64'
          #   build_job: 'build-windows'
          - artifact: linux-x86_64-unknown-linux-gnu
            pattern: '*.{AppImage,deb,rpm}'
            name: 'Linux-x64'
            build_job: 'build-linux'
          # - artifact: linux-aarch64-unknown-linux-gnu
          #   pattern: '*.{AppImage,deb,rpm}'
          #   name: 'Linux-ARM64'
          #   build_job: 'build-linux'
    steps:
      - name: Check if build succeeded
        id: check_build
        run: |
          if [ "${{ needs[matrix.build_job].result }}" = "success" ]; then
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
            echo "Build job ${{ matrix.build_job }} did not succeed, skipping artifact upload for ${{ matrix.artifact }}"
          fi

      - name: Download artifacts
        if: steps.check_build.outputs.build_success == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ./release-assets/
        continue-on-error: true

      - name: Upload Release Assets
        if: steps.check_build.outputs.build_success == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const { glob } = require('glob');

            const releaseId = '${{ needs.create-release.outputs.release_id }}';
            const artifactPath = './release-assets/';

            // Ê£ÄÊü•ÁõÆÂΩïÊòØÂê¶Â≠òÂú®
            if (!fs.existsSync(artifactPath)) {
              console.log(`Artifact path ${artifactPath} does not exist, skipping upload`);
              return;
            }

            // Êü•ÊâæÊâÄÊúâÂåπÈÖçÁöÑÊñá‰ª∂
            const files = await glob('${{ matrix.pattern }}', { cwd: artifactPath });

            if (files.length === 0) {
              console.log(`No files found matching pattern '${{ matrix.pattern }}' in ${artifactPath}`);
              return;
            }

            for (const file of files) {
              const filePath = path.join(artifactPath, file);
              const fileName = path.basename(file);
              const fileData = fs.readFileSync(filePath);

              // ÁîüÊàêÂ∏¶Âπ≥Âè∞Ê†áËØÜÁöÑÊñá‰ª∂Âêç
              const ext = path.extname(fileName);
              const baseName = path.basename(fileName, ext);
              const newFileName = `${baseName}-${{ matrix.name }}${ext}`;

              console.log(`Uploading ${newFileName}...`);

              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: releaseId,
                name: newFileName,
                data: fileData,
              });
            }

  # ‰∏ä‰º†ÁßªÂä®Á´ØÊûÑÂª∫‰∫ßÁâ© (Â¶ÇÊûúÂ≠òÂú®)
  upload-mobile-assets:
    needs: [create-release, build-ios, build-android]
    runs-on: ubuntu-latest
    if: always() && (needs.build-ios.result == 'success' || needs.build-android.result == 'success')
    steps:
      - name: Download iOS artifacts
        if: needs.build-ios.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: ios-build
          path: ./ios-assets/

      - name: Download Android artifacts
        if: needs.build-android.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: android-build
          path: ./android-assets/

      - name: Upload Mobile Assets
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const { glob: globPattern } = require('glob');

            const releaseId = '${{ needs.create-release.outputs.release_id }}';

            // ‰∏ä‰º† iOS Êñá‰ª∂
            if (fs.existsSync('./ios-assets/')) {
              const iosFiles = await globPattern('*.{ipa,app}', { cwd: './ios-assets/' });
              for (const file of iosFiles) {
                const filePath = path.join('./ios-assets/', file);
                const fileName = path.basename(file);
                const fileData = fs.readFileSync(filePath);

                console.log(`Uploading iOS ${fileName}...`);

                await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: releaseId,
                  name: `iOS-${fileName}`,
                  data: fileData,
                });
              }
            }

            // ‰∏ä‰º† Android Êñá‰ª∂
            if (fs.existsSync('./android-assets/')) {
              const androidFiles = await globPattern('*.apk', { cwd: './android-assets/' });
              for (const file of androidFiles) {
                const filePath = path.join('./android-assets/', file);
                const fileName = path.basename(file);
                const fileData = fs.readFileSync(filePath);

                console.log(`Uploading Android ${fileName}...`);

                await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: releaseId,
                  name: `Android-${fileName}`,
                  data: fileData,
                });
              }
            }

  # Ê∏ÖÁêÜÂ∑•‰ΩúÊµÅ‰∫ßÁâ©
  cleanup:
    needs: [upload-release-assets, upload-mobile-assets]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Delete workflow artifacts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            for (const artifact of artifacts.data.artifacts) {
              console.log(`Deleting artifact: ${artifact.name}`);
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
              });
            }
