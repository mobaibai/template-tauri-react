# å‰ç«¯æ„å»ºä¼˜åŒ–ä¸è¾¹ç•Œå¤„ç†

## æ¦‚è¿°

ä¸ºäº†ä¼˜åŒ–æ„å»ºæµç¨‹ï¼Œé¿å…é‡å¤æ‰§è¡Œå‰ç«¯æ„å»ºï¼Œæˆ‘ä»¬åœ¨æ„å»ºè„šæœ¬ä¸­å®ç°äº†æ™ºèƒ½çš„å‰ç«¯æ„å»ºæ£€æµ‹æœºåˆ¶ã€‚

## åŠŸèƒ½ç‰¹æ€§

### 1. æ™ºèƒ½å‰ç«¯æ„å»ºæ£€æµ‹

- **å­˜åœ¨æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹ `dist` ç›®å½•æ˜¯å¦å­˜åœ¨
- **å®Œæ•´æ€§æ£€æµ‹**: éªŒè¯ `dist` ç›®å½•æ˜¯å¦åŒ…å«å¿…è¦æ–‡ä»¶ï¼ˆå¦‚ `index.html`ï¼‰
- **ç¼“å­˜æœºåˆ¶**: é¿å…é‡å¤æ£€æŸ¥å’Œæ„å»ºï¼Œæé«˜æ„å»ºæ•ˆç‡

### 2. è¾¹ç•Œå¤„ç†åœºæ™¯

#### åœºæ™¯1: distç›®å½•å­˜åœ¨ä¸”å®Œæ•´

```bash
# è¾“å‡ºç¤ºä¾‹
[FRONTEND] å‰ç«¯æ„å»ºäº§ç‰©å·²å­˜åœ¨ä¸”å®Œæ•´ï¼Œè·³è¿‡å‰ç«¯æ„å»º
```

**å¤„ç†**: ç›´æ¥è·³è¿‡å‰ç«¯æ„å»ºï¼Œç»§ç»­åç»­æµç¨‹

#### åœºæ™¯2: distç›®å½•ä¸å­˜åœ¨

```bash
# è¾“å‡ºç¤ºä¾‹
[FRONTEND] å‰ç«¯æ„å»ºäº§ç‰©ä¸å­˜åœ¨æˆ–ä¸å®Œæ•´ï¼Œå¼€å§‹æ„å»ºå‰ç«¯...
[FRONTEND] æ‰§è¡Œå‘½ä»¤: npm run build
âœ… å‰ç«¯æ„å»ºå®Œæˆ
```

**å¤„ç†**: è‡ªåŠ¨æ‰§è¡Œ `npm run build` è¿›è¡Œå‰ç«¯æ„å»º

#### åœºæ™¯3: distç›®å½•å­˜åœ¨ä½†ä¸å®Œæ•´

```bash
# å½“ç¼ºå°‘å…³é”®æ–‡ä»¶å¦‚ index.html æ—¶
[FRONTEND] å‰ç«¯æ„å»ºäº§ç‰©ä¸å­˜åœ¨æˆ–ä¸å®Œæ•´ï¼Œå¼€å§‹æ„å»ºå‰ç«¯...
```

**å¤„ç†**: å¼ºåˆ¶é‡æ–°æ„å»ºå‰ç«¯

#### åœºæ™¯4: æ„å»ºè¿‡ç¨‹ä¸­distè¢«æ„å¤–åˆ é™¤

**ç›‘æ§æœºåˆ¶**: `monitorFrontendBuild()` å‡½æ•°ä¼šåœ¨æ¯ä¸ªå¹³å°æ„å»ºå‰æ£€æŸ¥ `dist` ç›®å½•
**å¤„ç†**: å¦‚æœæ£€æµ‹åˆ°ä¸¢å¤±ï¼Œè‡ªåŠ¨è§¦å‘é‡æ–°æ„å»º

#### åœºæ™¯5: æ„å»ºç¯å¢ƒé—®é¢˜

```bash
# ç¯å¢ƒæ£€æŸ¥ç¤ºä¾‹è¾“å‡º
[ENV] æ„å»ºç¯å¢ƒæ£€æŸ¥:
  âœ… Node.js ç‰ˆæœ¬: v22.17.0
  âœ… npm å¯ç”¨
  âœ… package.json å­˜åœ¨
  âœ… node_modules å­˜åœ¨
  âœ… é¡¹ç›®ç›®å½•å¯è®¿é—®
```

**å¤„ç†**: åœ¨æ„å»ºå¼€å§‹å‰è‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒï¼Œå‘ç°é—®é¢˜æ—¶æä¾›ä¿®å¤å»ºè®®

#### åœºæ™¯6: å‰ç«¯æ„å»ºå¤±è´¥é‡è¯•

```bash
# é‡è¯•æœºåˆ¶ç¤ºä¾‹
âŒ å‰ç«¯æ„å»ºå¤±è´¥ (å°è¯• 1/2): æ„å»ºäº§ç‰©ä¸å®Œæ•´
[FRONTEND] ç­‰å¾… 2 ç§’åé‡è¯•...
[FRONTEND] ç¬¬ 2 æ¬¡é‡è¯•æ„å»º...
```

**å¤„ç†**: è‡ªåŠ¨é‡è¯•æœ€å¤š2æ¬¡ï¼Œæ¯æ¬¡é‡è¯•å‰æ¸…ç†æ®‹ç•™æ–‡ä»¶

#### åœºæ™¯7: ä¾èµ–é—®é¢˜è‡ªåŠ¨ä¿®å¤

```bash
âš ï¸ æ£€æµ‹åˆ°ä¾èµ–é—®é¢˜ï¼Œå°è¯•ä¿®å¤...
```

**å¤„ç†**: æ£€æµ‹åˆ°ä¾èµ–é—®é¢˜æ—¶è‡ªåŠ¨è¿è¡Œ `npm install`

### 3. æ„å»ºçŠ¶æ€ç®¡ç†

```javascript
// å…¨å±€çŠ¶æ€å˜é‡
let frontendBuildChecked = false // æ˜¯å¦å·²æ£€æŸ¥è¿‡å‰ç«¯æ„å»º
let frontendBuildSuccess = false // å‰ç«¯æ„å»ºæ˜¯å¦æˆåŠŸ
let frontendBuildTime = 0 // å‰ç«¯æ„å»ºè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
```

### 4. æ ¸å¿ƒå‡½æ•°

#### `ensureFrontendBuild(forceRebuild = false)`

- ç¡®ä¿å‰ç«¯æ„å»ºäº§ç‰©å­˜åœ¨ä¸”å®Œæ•´
- æ”¯æŒå¼ºåˆ¶é‡å»ºé€‰é¡¹
- åŒ…å«é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š2æ¬¡é‡è¯•ï¼‰
- è‡ªåŠ¨æ£€æŸ¥å’Œä¿®å¤ä¾èµ–é—®é¢˜
- è¿”å›æ„å»ºç»“æœï¼ˆtrue/falseï¼‰

#### `monitorFrontendBuild()`

- ç›‘æ§å‰ç«¯æ„å»ºäº§ç‰©çŠ¶æ€
- æ£€æµ‹åˆ°é—®é¢˜æ—¶è‡ªåŠ¨é‡å»º

#### `resetFrontendBuildState()`

- é‡ç½®å‰ç«¯æ„å»ºçŠ¶æ€
- ç”¨äºéœ€è¦é‡æ–°æ£€æŸ¥çš„åœºæ™¯

#### `checkBuildEnvironment()`

- æ£€æŸ¥æ„å»ºç¯å¢ƒçš„å®Œæ•´æ€§
- éªŒè¯ Node.js ç‰ˆæœ¬ã€npm å¯ç”¨æ€§ã€ä¾èµ–å®‰è£…ç­‰
- æä¾›è¯¦ç»†çš„ç¯å¢ƒçŠ¶æ€æŠ¥å‘Š
- è¿”å›ç¯å¢ƒæ£€æŸ¥ç»“æœï¼ˆtrue/falseï¼‰

## é…ç½®

### æ„å»ºè„šæœ¬é…ç½®

æ„å»ºè„šæœ¬é€šè¿‡ `build.config.js`
æ–‡ä»¶è¿›è¡Œé…ç½®ï¼Œæ”¯æŒè‡ªå®šä¹‰æ„å»ºç›®æ ‡ã€è¾“å‡ºè·¯å¾„ç­‰é€‰é¡¹ã€‚

### Tauri é…ç½®ä¼˜åŒ–

ä¸ºäº†é¿å…é‡å¤å‰ç«¯æ„å»ºï¼Œå·²å°† `src-tauri/tauri.conf.json` ä¸­çš„ `beforeBuildCommand`
è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼š

```json
{
  "build": {
    "beforeDevCommand": "npm run dev",
    "beforeBuildCommand": "",
    "devUrl": "http://localhost:1420",
    "frontendDist": "../dist"
  }
}
```

**é‡è¦è¯´æ˜**ï¼š

- åŸé…ç½® `"beforeBuildCommand": "npm run build"` ä¼šå¯¼è‡´ Tauri è‡ªåŠ¨æ‰§è¡Œå‰ç«¯æ„å»º
- æˆ‘ä»¬çš„æ„å»ºè„šæœ¬å·²ç»åŒ…å«äº†å‰ç«¯æ„å»ºé€»è¾‘ï¼Œå› æ­¤ç§»é™¤æ­¤é…ç½®é¿å…é‡å¤æ„å»º
- è¿™æ ·ç¡®ä¿å‰ç«¯é¡¹ç›®åªæ„å»ºä¸€æ¬¡ï¼Œæå‡æ„å»ºæ•ˆç‡

## ä½¿ç”¨ç¤ºä¾‹

### æ„å»ºæ‰€æœ‰å¹³å°

```bash
yarn build:all
# æˆ–
node scripts/build.js
```

### æ„å»ºæ¡Œé¢å¹³å°

```bash
yarn build:desktop
# æˆ–
node scripts/build.js desktop
```

### æ„å»ºç§»åŠ¨å¹³å°

```bash
yarn build:mobile
# æˆ–
node scripts/build.js mobile
```

### æ„å»ºç‰¹å®šå¹³å°

```bash
node scripts/build.js mac-x86
```

## æ„å»ºç»Ÿè®¡ä¿¡æ¯

æ„å»ºå®Œæˆåä¼šæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼š

```bash
ğŸ“Š æ„å»ºç»Ÿè®¡ä¿¡æ¯:
   å‰ç«¯æ„å»ºè€—æ—¶: 5.92s
   å‰ç«¯æ„å»ºçŠ¶æ€: âœ… æˆåŠŸ
```

## é”™è¯¯å¤„ç†

### å‰ç«¯æ„å»ºå¤±è´¥

- æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
- è‡ªåŠ¨é€€å‡ºæ„å»ºæµç¨‹
- ä¿ç•™é”™è¯¯çŠ¶æ€ä¾›åç»­æ£€æŸ¥

### æ„å»ºäº§ç‰©éªŒè¯å¤±è´¥

- è‡ªåŠ¨é‡è¯•æ„å»º
- è®°å½•éªŒè¯å¤±è´¥åŸå› 
- æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º

## æ€§èƒ½ä¼˜åŒ–

1. **é¿å…é‡å¤æ„å»º**: é€šè¿‡çŠ¶æ€ç¼“å­˜æœºåˆ¶é¿å…ä¸å¿…è¦çš„å‰ç«¯æ„å»º
2. **å¿«é€Ÿæ£€æµ‹**: ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥è€Œéå®Œæ•´æ„å»ºæ¥éªŒè¯äº§ç‰©
3. **å¹¶è¡Œå¤„ç†**: å‰ç«¯æ„å»ºä¸å¹³å°æ„å»ºçš„åˆç†è°ƒåº¦
4. **å¢é‡æ›´æ–°**: åªåœ¨å¿…è¦æ—¶é‡æ–°æ„å»º

## æ³¨æ„äº‹é¡¹

1. **æ‰‹åŠ¨æ¸…ç†**: å¦‚éœ€å¼ºåˆ¶é‡æ–°æ„å»ºå‰ç«¯ï¼Œå¯å…ˆåˆ é™¤ `dist` ç›®å½•
2. **æ„å»ºç¯å¢ƒ**: ç¡®ä¿ Node.js å’Œç›¸å…³ä¾èµ–å·²æ­£ç¡®å®‰è£…
3. **æƒé™é—®é¢˜**: ç¡®ä¿å¯¹ `dist` ç›®å½•æœ‰è¯»å†™æƒé™
4. **ç£ç›˜ç©ºé—´**: ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´å­˜å‚¨æ„å»ºäº§ç‰©
5. **å·²ä¿®å¤**: è§£å†³äº†æ‰§è¡Œ `yarn build:mac-aarch` ç­‰å‘½ä»¤æ—¶é‡å¤æ‰§è¡Œå‰ç«¯æ„å»ºçš„é—®é¢˜

## ç‰ˆæœ¬æ›´æ–°è®°å½•

### v1.2.0 (æœ€æ–°)

- ğŸ› **å½»åº•ä¿®å¤é‡å¤æ„å»ºé—®é¢˜**: ç§»é™¤ `tauri.conf.json` ä¸­çš„ `beforeBuildCommand`
  é…ç½®ï¼Œå½»åº•è§£å†³é‡å¤å‰ç«¯æ„å»º
- ğŸ¨
  **ä¼˜åŒ–æ—¥å¿—è¾“å‡º**: å°†"å¼ºåˆ¶é‡æ–°æ„å»ºå‰ç«¯é¡¹ç›®"æ”¹ä¸º"æ„å»ºå‰ç«¯é¡¹ç›®"ï¼Œæä¾›æ›´æ¸…æ™°çš„æ„å»ºä¿¡æ¯
- ğŸ”§ **ç®€åŒ–æ„å»ºæµç¨‹**: ç§»é™¤ä¸å¿…è¦çš„å¼ºåˆ¶é‡å»ºæ­¥éª¤ï¼Œä¼˜åŒ–æ„å»ºé€»è¾‘
- âš¡ **æ€§èƒ½æå‡**: ç¡®ä¿å‰ç«¯é¡¹ç›®åªæ„å»ºä¸€æ¬¡ï¼Œæ˜¾è‘—æå‡æ„å»ºæ•ˆç‡

### v1.1.0

- ğŸ› **ä¿®å¤é‡å¤æ„å»ºé—®é¢˜**: è§£å†³äº† `monitorFrontendBuild()`
  å‡½æ•°é‡å¤è°ƒç”¨å‰ç«¯æ„å»ºçš„é—®é¢˜
- ğŸ”§ **ä¼˜åŒ–æ„å»ºæµç¨‹**: `monitorFrontendBuild()` ç°åœ¨åªè´Ÿè´£æ£€æŸ¥ï¼Œä¸å†æ‰§è¡Œé‡å»º
- âš¡ **æ€§èƒ½æå‡**: é¿å…äº†ä¸å¿…è¦çš„é‡å¤å‰ç«¯æ„å»ºï¼Œæå‡æ„å»ºé€Ÿåº¦
- ğŸ“ **é”™è¯¯æç¤ºä¼˜åŒ–**: æä¾›æ›´æ¸…æ™°çš„å‰ç«¯æ„å»ºäº§ç‰©æ£€æŸ¥é”™è¯¯ä¿¡æ¯

## æ•…éšœæ’é™¤

### å‰ç«¯æ„å»ºä¸€ç›´å¤±è´¥

1. **æ£€æŸ¥ Node.js ç‰ˆæœ¬å…¼å®¹æ€§**

   ```bash
   node --version  # ç¡®ä¿ç‰ˆæœ¬ >= 16.x
   ```

2. **æ¸…ç†ä¾èµ–å¹¶é‡æ–°å®‰è£…**

   ```bash
   rm -rf node_modules package-lock.json
   npm install
   ```

3. **æ£€æŸ¥ä»£ç æ ¼å¼å’Œç±»å‹é”™è¯¯**

   ```bash
   npm run type-check
   npm run format:check
   ```

4. **æŸ¥çœ‹è¯¦ç»†çš„æ„å»ºæ—¥å¿—**

   ```bash
   npm run build --verbose
   ```

5. **æ£€æŸ¥ç£ç›˜ç©ºé—´**
   ```bash
   df -h  # ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´
   ```

### ç¯å¢ƒæ£€æŸ¥å¤±è´¥

1. **Node.js ç‰ˆæœ¬è¿‡ä½**
   - å‡çº§åˆ° Node.js 16.x æˆ–æ›´é«˜ç‰ˆæœ¬
   - ä½¿ç”¨ nvm ç®¡ç†å¤šä¸ª Node.js ç‰ˆæœ¬

2. **npm ä¸å¯ç”¨**

   ```bash
   # é‡æ–°å®‰è£… npm
   npm install -g npm@latest
   ```

3. **ä¾èµ–ç¼ºå¤±**
   ```bash
   # æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–
   npm audit fix
   npm install
   ```

### distç›®å½•æ£€æµ‹å¼‚å¸¸

1. **æ–‡ä»¶ç³»ç»Ÿæƒé™é—®é¢˜**

   ```bash
   # æ£€æŸ¥æƒé™
   ls -la dist/
   # ä¿®å¤æƒé™ï¼ˆå¦‚éœ€è¦ï¼‰
   chmod -R 755 dist/
   ```

2. **è·¯å¾„é—®é¢˜**
   - ç¡®è®¤å½“å‰å·¥ä½œç›®å½•æ­£ç¡®
   - æ£€æŸ¥é¡¹ç›®æ ¹ç›®å½•ç»“æ„

3. **æ–‡ä»¶è¢«å ç”¨**
   ```bash
   # æ£€æŸ¥æ–‡ä»¶å ç”¨æƒ…å†µ
   lsof +D dist/
   ```

### æ„å»ºç¼“å­˜é—®é¢˜

1. **æ¸…ç†æ‰€æœ‰ç¼“å­˜**

   ```bash
   yarn clean:all
   npm run clean
   ```

2. **å¼ºåˆ¶é‡å»ºå‰ç«¯**

   ```bash
   rm -rf dist/
   npm run build
   ```

3. **æ¸…ç†ç³»ç»Ÿç¼“å­˜**

   ```bash
   # æ¸…ç† npm ç¼“å­˜
   npm cache clean --force

   # æ¸…ç† yarn ç¼“å­˜
   yarn cache clean
   ```

### ç½‘ç»œç›¸å…³é—®é¢˜

1. **ä¾èµ–ä¸‹è½½å¤±è´¥**

   ```bash
   # ä½¿ç”¨å›½å†…é•œåƒ
   npm config set registry https://registry.npmmirror.com/
   ```

2. **è¶…æ—¶é—®é¢˜**
   ```bash
   # å¢åŠ è¶…æ—¶æ—¶é—´
   npm config set timeout 60000
   ```

### å¹³å°ç‰¹å®šé—®é¢˜

1. **macOS æƒé™é—®é¢˜**

   ```bash
   # ç»™äºˆç»ˆç«¯å®Œå…¨ç£ç›˜è®¿é—®æƒé™
   # ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§ > éšç§ > å®Œå…¨ç£ç›˜è®¿é—®æƒé™
   ```

2. **Windows è·¯å¾„é•¿åº¦é™åˆ¶**

   ```bash
   # å¯ç”¨é•¿è·¯å¾„æ”¯æŒ
   git config --system core.longpaths true
   ```

3. **Linux æ–‡ä»¶æè¿°ç¬¦é™åˆ¶**
   ```bash
   # å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
   ulimit -n 65536
   ```
